<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Viewer WebRTC</title>
    <style>
        body {
            font-family: sans-serif;
            background: #111;
            color: #eee;
            text-align: center;
        }

        video {
            width: 90vw;
            max-width: 800px;
            margin-top: 20px;
            background: #000;
        }

        #status {
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <h2>Streaming video -- Prueba</h2>
    <p id="status">Estado: inicializando...</p>
    <video id="remoteVideo" autoplay playsinline controls></video>

    <script>
        const pc = new RTCPeerConnection();

        // ESTA LÍNEA ES IMPRESCINDIBLE:
        // Le dice a Chrome "quiero recibir vídeo"
        pc.addTransceiver("video", { direction: "recvonly" });

        pc.ontrack = (event) => {
            console.log("Track recibido", event);
            document.getElementById("remoteVideo").srcObject = event.streams[0];
            document.getElementById("status").textContent = "Estado: recibiendo vídeo";
        };

        pc.oniceconnectionstatechange = () => {
            console.log("ICE state:", pc.iceConnectionState);
        };

        async function start() {
            document.getElementById("status").textContent = "Esperando video (Hacer click al Play)";

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            const response = await fetch("/viewer_offer", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    sdp: pc.localDescription.sdp,
                    type: pc.localDescription.type,
                }),
            });

            if (!response.ok) {
                const text = await response.text();
                document.getElementById("status").textContent =
                    "Error desde el servidor: " + text;
                throw new Error(text);
            }

            const answer = await response.json();
            await pc.setRemoteDescription(answer);

            document.getElementById("status").textContent =
                "Conectado - Video en streaming";
        }

        start().catch(err => {
            console.error(err);
            document.getElementById("status").textContent = "Error: " + err;
        });
    </script>

</body>
</html>
